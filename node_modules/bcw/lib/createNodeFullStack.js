let fs = require("fs");
let { execSync } = require("child_process");
let { colors, startSpinner, stopSpinner } = require('../console-utils');
const { generateWorkspace } = require("./generateWorkspace");
const { generatePackageJson } = require("./generatePackageJson");

const templates = {
  'express-mvc': 'mvc-auth#main',
  'express-vue': 'vue-starter#main',
  'express-react': 'react-starter#main'
}


async function createNodeFullStack(CURR_DIR, projectName, projectChoice = '') {
  return new Promise((resolve, reject) => {
    try {
      let client = templates[projectChoice]
      console.group()
      let projPath = `${CURR_DIR}/${projectName}`;
      fs.mkdirSync(projPath);
      process.chdir(projPath);

      execSync(`npx create-project client --name="${projectName}" codeworks-templates/${client}`);
      execSync(`npx create-project server --name="${projectName}" codeworks-templates/node-server-auth0`);
      let envContents = ["NODE_ENV=dev", "CONNECTION_STRING=", "PORT=", "AUTH_DOMAIN=", "AUTH_AUDIENCE=", "AUTH_CLIENT_ID=", "ROUTE_PREFIX="];
      fs.writeFileSync(`${projPath}/server/.env`, envContents.join("\n"), "utf8");
      fs.writeFileSync(`${projPath}/${projectName}.code-workspace`, generateWorkspace(projectName), "utf8");
      fs.writeFileSync(`${projPath}/package.json`, generatePackageJson(projectName), "utf8");
      console.groupCollapsed(colors.FgMagenta, "  [~] Installing Dependencies", colors.Reset);
      startSpinner();
      try {
        execSync('npm run setup:app')
      } catch (e) {
        console.warn('[INSTALLING_DEPENDENCIES] Failed to install dependencies', e.message)
      }
      stopSpinner();
      console.groupEnd();
      resolve(`
        [#] Open Project Workspace
        [#] cd into ${projectName}
        [#] type 'code ${projectName}.code-workspace'`)
      console.groupEnd();
    } catch (e) {
      reject(e)
    }
  })
}

exports.createNodeFullStack = createNodeFullStack;
